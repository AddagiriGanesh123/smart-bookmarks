const fs = require('fs');

let html = fs.readFileSync('frontend/index.html', 'utf8');

html = html.replace(/<button class="chat-nav-btn"[\s\S]*?<\/script>/g, '');

html = html.replace(
  /<!-- Messages Page -->[\s\S]*?<\/main>/,
  '<!-- Messages Page -->\n    <div id="page-messages" class="page">\n      <div class="page-header"><h1>Patient Messages</h1></div>\n      <div class="msg-layout">\n        <div class="msg-sidebar">\n          <div class="msg-sidebar-header">Conversations</div>\n          <div id="msg-patient-items"><div class="msg-loading">Loading...</div></div>\n        </div>\n        <div class="msg-main" id="msg-chat-area">\n          <div class="msg-welcome">\n            <div class="msg-welcome-icon">msg</div>\n            <h3>Patient Messages</h3>\n            <p>Select a patient to view messages</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  </main>'
);

fs.writeFileSync('frontend/index.html', html, 'utf8');
console.log('index.html done');

let js = fs.readFileSync('frontend/js/app.js', 'utf8');

if (!js.includes('loadMessages')) {
  js = js.replace("  if (page === 'bills') loadBills();\n}", "  if (page === 'bills') loadBills();\n  if (page === 'messages') loadMessages();\n}");

  const msgCode = '\nasync function loadMessages() {\n  await _refreshMsgList();\n  if (!_msgPoll) _msgPoll = setInterval(function(){ _refreshMsgList(); if(_msgSel)_loadMsgs(_msgSel.id); }, 8000);\n}\nvar _msgSel=null,_msgPrio="normal",_msgPoll=null;\nasync function _refreshMsgList(){\n  var pts=await api("/chat/patients");\n  var box=document.getElementById("msg-patient-items");\n  if(!box){clearInterval(_msgPoll);_msgPoll=null;return;}\n  var total=Array.isArray(pts)?pts.reduce(function(s,p){return s+(p.unread_count||0);},0):0;\n  var badge=document.getElementById("nav-msg-badge");\n  if(badge){badge.textContent=total;badge.style.display=total>0?"inline":"none";}\n  if(!Array.isArray(pts)||!pts.length){box.innerHTML="<div class=msg-loading>No messages yet</div>";return;}\n  box.innerHTML=pts.map(function(p){\n    var active=_msgSel&&_msgSel.id===p.id?" active":"";\n    var last=p.last_message?p.last_message.substring(0,38):"No messages";\n    var col=p.highest_priority==="urgent"?"#ef4444":p.highest_priority==="high"?"#f97316":"#1a73e8";\n    var time=p.last_message_at?new Date(p.last_message_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"";\n    var unread=p.unread_count>0?"<span class=msg-unread-dot>"+p.unread_count+"</span>":"";\n    return "<div class=\\"msg-pt-item"+active+"\\" onclick=\\"_selectMsgPt("+p.id+",\'"+p.name+"\',\'"+p.patient_id+"\')\\">"\n      +"<div class=msg-pt-avatar style=\\"background:"+col+"22;color:"+col+"\\">"+p.name.charAt(0).toUpperCase()+"</div>"\n      +"<div class=msg-pt-info>"\n      +"<div class=msg-pt-top><span class=msg-pt-name>"+p.name+"</span><span class=msg-pt-time>"+time+"</span></div>"\n      +"<div class=msg-pt-sub><span class=msg-pt-last>"+last+"</span>"+unread+"</div>"\n      +"</div></div>";\n  }).join("");\n}\nasync function _selectMsgPt(id,name,pid){\n  _msgSel={id:id,name:name,pid:pid};_msgPrio="normal";\n  await api("/chat/read/"+id,{method:"PUT"});\n  _refreshMsgList();\n  var area=document.getElementById("msg-chat-area");\n  area.innerHTML="<div class=msg-chat-topbar>"\n    +"<div class=msg-chat-avatar>"+name.charAt(0).toUpperCase()+"</div>"\n    +"<div><div class=msg-chat-name>"+name+"</div><div class=msg-chat-pid>"+pid+"</div></div>"\n    +"</div>"\n    +"<div class=msg-bubbles id=msg-bubbles></div>"\n    +"<div class=msg-composer>"\n    +"<div class=msg-prio-row><span>Priority:</span>"\n    +"<button class=\\"mpb sel\\" id=mpb-normal onclick=\\"_setPrio(\'normal\')\\">Normal</button>"\n    +"<button class=mpb id=mpb-high onclick=\\"_setPrio(\'high\')\\">High</button>"\n    +"<button class=mpb id=mpb-urgent onclick=\\"_setPrio(\'urgent\')\\">Urgent</button>"\n    +"</div>"\n    +"<div class=msg-input-row>"\n    +"<textarea id=msg-inp placeholder=\\"Type reply...\\" onkeydown=\\"_msgEnter(event)\\"></textarea>"\n    +"<button class=msg-send onclick=\\"_sendMsg()\\">send</button>"\n    +"</div></div>";\n  _loadMsgs(id);\n}\nfunction _setPrio(p){\n  _msgPrio=p;\n  ["normal","high","urgent"].forEach(function(x){var b=document.getElementById("mpb-"+x);if(b)b.className="mpb"+(p===x?" sel sel-"+p:"");});\n}\nasync function _loadMsgs(pid){\n  var msgs=await api("/chat/patients/"+pid);\n  var box=document.getElementById("msg-bubbles");\n  if(!box)return;\n  if(!Array.isArray(msgs)||!msgs.length){box.innerHTML="<div class=msg-no-msgs>No messages yet</div>";return;}\n  box.innerHTML=msgs.map(function(m){\n    var ip=m.sender_role==="patient";\n    var t=new Date(m.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});\n    var sender=ip?"Patient":(m.staff_name||"Staff");\n    return "<div class=\\"msg-row "+(ip?"from-patient":"from-staff")+"\\\">"\n      +"<div class=\\"msg-bubble "+(ip?"bub-patient":"bub-staff")+"\\\">"\n      +"<div class=bub-text>"+m.message.replace(/\\n/g,"<br>")+"</div>"\n      +"<div class=bub-time>"+sender+" - "+t+"</div>"\n      +"</div></div>";\n  }).join("");\n  box.scrollTop=box.scrollHeight;\n}\nasync function _sendMsg(){\n  var inp=document.getElementById("msg-inp");\n  if(!inp||!_msgSel)return;\n  var msg=inp.value.trim();if(!msg)return;\n  inp.value="";\n  await api("/chat/send",{method:"POST",body:JSON.stringify({patient_id:_msgSel.id,message:msg,priority:_msgPrio})});\n  _loadMsgs(_msgSel.id);_refreshMsgList();\n}\nfunction _msgEnter(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();_sendMsg();}}\nsetInterval(async function(){var d=await api("/chat/unread-total").catch(function(){return null;});if(!d)return;var b=document.getElementById("nav-msg-badge");if(b){b.textContent=d.total;b.style.display=d.total>0?"inline":"none";}},15000);\ndocument.querySelectorAll(".nav-links li").forEach(function(li){li.addEventListener("click",function(){if(li.dataset.page!=="messages"&&_msgPoll){clearInterval(_msgPoll);_msgPoll=null;_msgSel=null;}});});\n';

  js = js.replace('// ── Helpers', msgCode + '\n// ── Helpers');
  fs.writeFileSync('frontend/js/app.js', js, 'utf8');
  console.log('app.js done');
} else {
  js = js.replace(/getElementById\("msg-patient-list"\)/g, 'getElementById("msg-patient-items")');
  js = js.replace(/getElementById\('msg-patient-list'\)/g, "getElementById('msg-patient-items')");
  fs.writeFileSync('frontend/js/app.js', js, 'utf8');
  console.log('app.js IDs fixed');
}

let css = fs.readFileSync('frontend/css/style.css', 'utf8');
if (!css.includes('msg-layout')) {
  css += '\n.msg-layout{display:flex;height:calc(100vh - 130px);background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(26,35,126,0.08);overflow:hidden;}\n.msg-sidebar{width:280px;flex-shrink:0;display:flex;flex-direction:column;border-right:1px solid #e8edf3;}\n.msg-sidebar-header{padding:16px 18px;font-size:14px;font-weight:700;color:#1a237e;background:#f0f4ff;border-bottom:1px solid #e0e7ff;}\n#msg-patient-items{flex:1;overflow-y:auto;}\n.msg-loading,.msg-no-msgs{padding:24px;text-align:center;color:#aaa;font-size:13px;}\n.msg-pt-item{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;border-bottom:1px solid #f0f2f7;transition:background 0.15s;}\n.msg-pt-item:hover{background:#f5f7ff;}\n.msg-pt-item.active{background:#eef2ff;border-left:3px solid #1a73e8;}\n.msg-pt-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0;}\n.msg-pt-info{flex:1;min-width:0;}\n.msg-pt-top{display:flex;justify-content:space-between;margin-bottom:3px;}\n.msg-pt-name{font-size:13px;font-weight:600;color:#1a237e;}\n.msg-pt-time{font-size:10px;color:#aaa;}\n.msg-pt-sub{display:flex;justify-content:space-between;align-items:center;}\n.msg-pt-last{font-size:11px;color:#777;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px;}\n.msg-unread-dot{background:#1a73e8;color:#fff;border-radius:50%;min-width:18px;height:18px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 3px;}\n.msg-main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#f8fafc;}\n.msg-welcome{margin:auto;text-align:center;padding:40px;}\n.msg-welcome h3{color:#1a237e;font-size:18px;margin-bottom:8px;}\n.msg-welcome p{color:#999;font-size:13px;}\n.msg-chat-topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;background:#fff;border-bottom:1px solid #e8edf3;flex-shrink:0;}\n.msg-chat-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#1a73e8,#0d47a1);color:#fff;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:700;}\n.msg-chat-name{font-size:15px;font-weight:700;color:#1a237e;}\n.msg-chat-pid{font-size:11px;color:#888;margin-top:2px;}\n.msg-bubbles{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}\n.msg-row{display:flex;}\n.from-patient{justify-content:flex-start;}\n.from-staff{justify-content:flex-end;}\n.msg-bubble{max-width:68%;padding:10px 14px;border-radius:16px;}\n.bub-patient{background:#fff;border:1px solid #e0e7ff;border-bottom-left-radius:4px;}\n.bub-staff{background:linear-gradient(135deg,#1a73e8,#1557b0);color:#fff;border-bottom-right-radius:4px;}\n.bub-text{font-size:13px;line-height:1.6;}\n.bub-time{font-size:10px;margin-top:4px;opacity:0.6;}\n.msg-composer{background:#fff;border-top:1px solid #e8edf3;padding:12px 16px;flex-shrink:0;}\n.msg-prio-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;}\n.msg-prio-row span{font-size:12px;color:#888;font-weight:600;}\n.mpb{padding:4px 12px;border-radius:20px;border:2px solid #e0e0e0;background:#fff;font-size:11px;font-weight:700;cursor:pointer;}\n.mpb.sel{border-color:#22c55e;background:#dcfce7;color:#166534;}\n.mpb.sel-high{border-color:#f97316 !important;background:#ffedd5 !important;color:#9a3412 !important;}\n.mpb.sel-urgent{border-color:#ef4444 !important;background:#fee2e2 !important;color:#991b1b !important;}\n.msg-input-row{display:flex;gap:10px;align-items:flex-end;}\n.msg-input-row textarea{flex:1;resize:none;height:42px;padding:10px 14px;border:2px solid #e0e0e0;border-radius:21px;font-size:13px;font-family:inherit;}\n.msg-input-row textarea:focus{outline:none;border-color:#1a73e8;}\n.msg-send{background:linear-gradient(135deg,#1a73e8,#0d47a1);color:#fff;border:none;border-radius:50%;width:42px;height:42px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}\n';
  fs.writeFileSync('frontend/css/style.css', css, 'utf8');
  console.log('style.css done');
}
console.log('ALL DONE');
